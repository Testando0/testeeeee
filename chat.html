<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuromi Messenger - Chats</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="kuromi-bg">
    <div class="container chat-container">
        <header class="kuromi-header">
            <span id="current-user-info">Bem-vinda, [Username] 😈</span>
            <button id="logout-btn" class="kuromi-btn logout-btn">Sair</button>
        </header>

        <h2 class="kuromi-title-2">Buscar Amigos 🔍</h2>
        <div class="search-box">
            <input type="text" id="user-search" placeholder="Pesquisar username..." class="kuromi-input-search">
        </div>
        
        <div id="search-results" class="results-list">
            </div>

        <h2 class="kuromi-title-2">Minhas Conversas 💬</h2>
        <div id="my-chats" class="results-list">
            <p class="kuromi-subtitle">Você ainda não tem conversas. Busque um amigo!</p>
        </div>

    </div>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const userSearchInput = document.getElementById('user-search');
            const searchResultsDiv = document.getElementById('search-results');
            const currentUserInfoSpan = document.getElementById('current-user-info');
            const logoutBtn = document.getElementById('logout-btn');

            // 1. Verificar se está logado e obter perfil
            const profile = await getProfile();
            if (!profile) {
                // Se não estiver logado, redireciona
                window.location.href = 'index.html';
                return;
            }
            currentUserInfoSpan.textContent = `Bem-vinda, ${profile.username} 🎀`;

            // 2. Lógica de Logout
            logoutBtn.addEventListener('click', async () => {
                const { error } = await supabase.auth.signOut();
                if (!error) {
                    window.location.href = 'index.html';
                } else {
                    alert('Erro ao sair.');
                }
            });

            // 3. Lógica de Pesquisa
            userSearchInput.addEventListener('input', async () => {
                const query = userSearchInput.value.trim();
                searchResultsDiv.innerHTML = '';
                
                if (query.length < 2) {
                    searchResultsDiv.innerHTML = '<p class="kuromi-subtitle">Digite pelo menos 2 letras para pesquisar.</p>';
                    return;
                }

                const users = await searchUsers(query);
                
                if (users.length === 0) {
                    searchResultsDiv.innerHTML = '<p class="kuromi-subtitle">Nenhum usuário encontrado 😔.</p>';
                    return;
                }

                users.forEach(user => {
                    if (user.id !== profile.id) { // Não mostra o próprio usuário
                        const userCard = document.createElement('div');
                        userCard.className = 'user-card';
                        userCard.innerHTML = `
                            <span>${user.username}</span>
                            <button class="kuromi-btn start-chat-btn" data-user-id="${user.id}">Conversar</button>
                        `;
                        // Lógica para iniciar o chat (exige as tabelas messages/conversations)
                        userCard.querySelector('.start-chat-btn').addEventListener('click', () => {
                            alert(`Iniciando chat privado com ${user.username}...`);
                            // Aqui você faria a lógica de verificar/criar a conversa e redirecionar
                        });
                        searchResultsDiv.appendChild(userCard);
                    }
                });
            });
        });
    </script>
</body>
</html>
